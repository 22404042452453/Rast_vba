' Тестовый скрипт для определения кодов sta одностороннего отключения

Set spBranch = Rastr.Tables("vetv")
Set spNode = Rastr.Tables("node")

PrepareTemplate

' Поля ветвей
Set spBranchNm = spBranch.Cols("name")
Set spBranchSta = spBranch.Cols("sta")

' Поля узлов
Set spNodeSta = spNode.Cols("sta")

Set spExcel = CreateObject("Excel.Application")
spExcel.SheetsInNewWorkbook = 1
spExcel.Workbooks.Add
spExcel.Visible = true

' Лист для результатов
Set sheetTest = spExcel.Worksheets(1)
sheetTest.Name = "Тест sta"

sheetTest.Cells(1,1).Value = "Ветвь"
sheetTest.Cells(1,2).Value = "sta"
sheetTest.Cells(1,3).Value = "Статус"

TopologyStore

' Собираем индексы для односторонних отключений (S)
Dim SIndexes()
spBranch.SetSel("S")
ReDim SIndexes(spBranch.Count)
BranchCount = 0
ndx = spBranch.FindNextSel(-1)
while ndx >= 0
    SIndexes(BranchCount) = ndx
    BranchCount = BranchCount + 1
    ndx = spBranch.FindNextSel(ndx)
wend

if BranchCount = 0 Then
    MsgBox "Нет ветвей с галочкой 'Одностор. откл'", vbExclamation, "Тест sta"
End If

ReDim Preserve SIndexes(BranchCount-1)

row = 2

for i = 0 to BranchCount-1
    ndx = SIndexes(i)
    branchName = spBranchNm.ZS(ndx)

    for staCode = 1 to 10
        TopologyRestore
        spBranchSta.Z(ndx) = staCode

        Rastr.LogEnable = 0
        Status = Rastr.rgm("p")
        Rastr.LogEnable = 1

        statusText = ""
        if Status = AST_OK Then
            statusText = "OK"
        Else
            statusText = "Не сошелся"
        End If

        MsgBox "Ветвь: " & branchName & vbCrLf & "sta: " & staCode & vbCrLf & "Статус: " & statusText, vbInformation, "Тест sta"

        sheetTest.Cells(row,1).Value = branchName
        sheetTest.Cells(row,2).Value = staCode
        sheetTest.Cells(row,3).Value = statusText

        row = row + 1
    next
next

sheetTest.Columns.AutoFit

MsgBox "Тест завершен. Результаты в Excel.", vbInformation, "Тест sta"

Sub TopologyStore
    on error resume next
    spNode.Cols.Add "staRes",PR_BOOL
    spBranch.Cols.Add "staRes",PR_BOOL
    on error goto 0
    spNode.SetSel ""
    spNode.Cols("staRes").Calc("sta")
    spBranch.SetSel ""
    spBranch.Cols("staRes").Calc("sta")
End Sub

Sub TopologyRestore
    spNode.SetSel ""
    spNodeSta.Calc("staRes")
    spBranch.SetSel ""
    spBranchSta.Calc("staRes")
End Sub

Sub PrepareTemplate
    FieldsAdded = 0
    if spBranch.Cols.Find("S") < 0 Then
        spBranch.Cols.Add "S", PR_BOOL
        spBranch.Cols("S").Prop(FL_ZAG) = "Одностор. откл"
        FieldsAdded = 1
    End If
    if FieldsAdded = 1 Then
        MsgBox "Необходимые поля добавлены. Выберите ветви и запустите макрос повторно.",1,"Вариантные расчеты"
    End If
End Sub
